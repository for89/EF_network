---
title: "Mapping the Structure of Executive Function in Early Childhood: A Network Analysis Approach" 
shorttitle: "Mapping Executive Function"

author:
- name: "Fionnuala O'Reilly" 
  orcid: 0000-0002-4355-9088 
  affiliations: 
    - ref: stanford

- name: "Jelena Sucevic" 
  orcid: 0000-0001-5091-5434 
  affiliations: 
    - ref: oxford

- name: "Steven Howard" 
  orcid: 0000-0002-1258-3210 
  affiliations: 
    - ref: wollongong

- name: "Gaia Scerif" 
  orcid: 0000-0002-6371-8874 
  affiliations: 
    - ref: wollongong

affiliations: 
  - id: stanford 
    name: "Stanford University" 
  - id: oxford 
    name: "University of Oxford" 
  - id: wollongong 
    name: "University of Wollongong"

author-note: 
  disclosures: 
    financial-support: "This work was supported by X." 
    conflict-of-interest: "The author has no conflict of interest to declare."

abstract: TO BE ADDED.

keywords: ["executive function"] 
word-count: true

bibliography: library.bib

floatsintext: true
numbered-lines: true
# draft: false
mask: false

# figurelist: no
# tablelist: no
# footnotelist: no

format:
  apaquarto-pdf:
    documentmode: man
    keep-tex: true
    include-in-header: preamble.tex
    fig-format: png
    # fig-pos: H        
    # tbl-pos: H

knitr:
  opts_chunk:
    ft.arraystretch: 1.25

execute:
  echo: false 
  message: false 
  warning: false 
  error: true 
  cache: true
---

```{r setup}
#| include: false
#| cache: false

library(tidyverse)
library(here)
library(glue)
library(purrr)
library(viridis)
library(flextable)
library(lavaan)
library(broom.mixed)
library(lmerTest)
library(png)
library(emmeans)
library(dplyr)
library(ggplot2)
library(stringr)
library(psych) 
library(tibble)
library(haven)
library(BGGM)
library(networktools)  
library(qgraph) 

if (requireNamespace("conflicted", quietly = TRUE)) {
  conflicted::conflicts_prefer(
    dplyr::select,
    dplyr::filter,
    dplyr::lag,
    dplyr::rename,
    tidyr::extract
  )
  options(conflicted.policy = "strict") 
}

```

```{r load data}
#| cache: false

#load data
aus_data <- read_sav("~/Library/CloudStorage/GoogleDrive-foreilly@stanford.edu/My Drive/EF_network analysis/DECRA Master Dataset (T1-T3) 2020-10-16 (1).sav")
colnames(aus_data)
View(aus_data)
```

```{r explore data}
#| cache: false

ef_vars <- c(
  "MrAnt_Pt_T1","GNG_IC_T1","CS_SwAcc_T1",
  "MrAnt_Pt_T2","GNG_IC_T2","CS_SwAcc_T2",
  "MrAnt_Pt_T3","GNG_IC_T3","CS_SwAcc_T3"
)

# EF t1 vars
ggplot(aus_data, aes(x = Age, y = MrAnt_Pt_T1)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = GNG_IC_T1)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = CS_SwAcc_T1)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

# EF t2 vars
ggplot(aus_data, aes(x = Age, y = MrAnt_Pt_T2)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = GNG_IC_T2)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = CS_SwAcc_T2)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

# EF t3 vars
ggplot(aus_data, aes(x = Age, y = MrAnt_Pt_T3)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = GNG_IC_T3)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

ggplot(aus_data, aes(x = Age, y = CS_SwAcc_T3)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE)

# missingness
miss_var <- aus_data |>
  summarise(across(all_of(ef_vars),
                   list(n_miss = ~sum(is.na(.)),
                        pct_miss = ~mean(is.na(.))*100,
                        n_nonmiss = ~sum(!is.na(.))),
                   .names = "{.col}__{.fn}")) |>
  pivot_longer(everything(),
               names_to = c("variable","metric"),
               names_sep = "__",
               values_to = "value") |>
  pivot_wider(names_from = metric, values_from = value) |>
  arrange(desc(pct_miss))

miss_var

# check skew - skew > 2 or kurtosis > 7 problematic
ef_desc <- psych::describe(aus_data[ef_vars]) |>
  as.data.frame() |>
  tibble::rownames_to_column("variable") |>
  transmute(
    variable, n, mean, sd, median, min, max,
    skew   = skew, 
    kurt   = kurtosis,   # note: psych uses "kurtosis" column name
    se
  ) |>
  arrange(variable)
ef_desc
# all within range; no transformations required.

# histograms
ef_long <- aus_data |>
  select(Age, all_of(ef_vars)) |>
  pivot_longer(cols = all_of(ef_vars), names_to = "var", values_to = "value") |>
  mutate(
    timepoint = str_extract(var, "T[123]"),
    construct = case_when(
      str_starts(var, "MrAnt") ~ "WM",
      str_starts(var, "GNG")   ~ "INH",
      str_starts(var, "CS_")   ~ "SHIFT",
      TRUE ~ "EF"
    )
  )

ggplot(ef_long, aes(x = value)) +
  geom_histogram(bins = 30, na.rm = TRUE) +
  facet_wrap(~ var, scales = "free") +
  labs(title = "EF distributions", x = NULL, y = "Count")

# check outliers
z_df <- aus_data |>
  mutate(across(all_of(ef_vars), ~ (.-mean(., na.rm=TRUE))/sd(., na.rm=TRUE),
                .names = "z_{.col}"))

outlier_flags <- z_df |>
  transmute(across(starts_with("z_"), ~ abs(.) > 3.5, .names = "{.col}_out")) |>
  bind_cols(aus_data |> select(all_of(ef_vars)))  # keep originals alongside

# How many outliers per variable?
outlier_summary <- outlier_flags |>
  summarise(across(ends_with("_out"), ~ sum(.x, na.rm = TRUE))) |>
  pivot_longer(everything(), names_to = "flag", values_to = "n_outliers") |>
  mutate(variable = str_remove(flag, "^z_"),
         variable = str_remove(variable, "_out$")) |>
  arrange(desc(n_outliers))

outlier_summary

```
give a summary of the data checks. 

Histograms indicated that all executive-function task scores were approximately symmetric and unimodal. Mean performance increased and variability decreased across time, consistent with developmental improvements. No evidence of severe skewness, kurtosis, or ceiling/floor effects was observed, so raw scores were retained for analysis.
```{r split by wave}
ef_map <- list(
  T1 = c("MrAnt_Pt_T1","GNG_IC_T1","CS_SwAcc_T1"),
  T2 = c("MrAnt_Pt_T2","GNG_IC_T2","CS_SwAcc_T2"),
  T3 = c("MrAnt_Pt_T3","GNG_IC_T3","CS_SwAcc_T3")
)

extract_wave <- function(df, vars) {
  stopifnot(length(vars) == 3, all(vars %in% names(df)))
  out <- dplyr::select(df, dplyr::all_of(vars))
  colnames(out) <- c("mr_ant", "gng", "cs")
  out
}

# now this works
Y_t1 <- extract_wave(aus_data, ef_map$T1)
Y_t2 <- extract_wave(aus_data, ef_map$T2)
Y_t3 <- extract_wave(aus_data, ef_map$T3)

Z_t1 <- as.data.frame(scale(Y_t1))
Z_t2 <- as.data.frame(scale(Y_t2))
Z_t3 <- as.data.frame(scale(Y_t3))

```

```{r estimate BGGM networks per wave}
set.seed(42)
# estimate() gives posterior for every partial correlation (edge)
fit_t1 <- BGGM::estimate(Z_t1, type = "continuous", iter = 10000, impute = TRUE)
fit_t2 <- BGGM::estimate(Z_t2, type = "continuous", iter = 10000, impute = TRUE)
fit_t3 <- BGGM::estimate(Z_t3, type = "continuous", iter = 10000, impute = TRUE)

```

```{r Extract posterior-mean partial correlation matrices (pcor) and weighted adjacency (pcor with tiny edges set to 0, depending on class)}
pc_t1 <- BGGM::pcor_mat(fit_t1)
pc_t2 <- BGGM::pcor_mat(fit_t2)
pc_t3 <- BGGM::pcor_mat(fit_t3)
```

```{r expected influence and global strength}
# Expected Influence (EI)
ei_t1 <- networktools::expectedInf(pc_t1)$step1
ei_t2 <- networktools::expectedInf(pc_t2)$step1
ei_t3 <- networktools::expectedInf(pc_t3)$step1

# Strength centrality (sum of edges). Drop diagonals.
strength <- function(M){
  diag(M) <- 0
  rowSums(abs(M))
}
str_t1 <- strength(pc_t1)
str_t2 <- strength(pc_t2)
str_t3 <- strength(pc_t3)
```

```{r Global strength}
global_strength <- function(M){
  sum(abs(M[upper.tri(M)]))
}
gs_t1 <- global_strength(pc_t1)
gs_t2 <- global_strength(pc_t2)
gs_t3 <- global_strength(pc_t3)

print(gs_t1)
print(gs_t2)
print(gs_t3)
```

```{r pairwise Bayesian comparisons of networks}

cmp_t1_t2 <- BGGM::ggm_compare_estimate(Z_t1, Z_t2, type = "continuous", iter = 10000, impute = TRUE)
cmp_t1_t3 <- BGGM::ggm_compare_estimate(Z_t1, Z_t3, type = "continuous", iter = 10000, impute = TRUE)
cmp_t2_t3 <- BGGM::ggm_compare_estimate(Z_t2, Z_t3, type = "continuous", iter = 10000, impute = TRUE)

summary(cmp_t1_t2)  # posterior summaries of edge differences
summary(cmp_t2_t3)
plot(summary(cmp_t1_t2))   #visual of credible intervals
plot(summary(cmp_t2_t3)) # note label is wrong
```

```{r plots}
labs <- c("Mr Ant","Go/No-Go","Card Sort")
qgraph(pc_t1, layout = "spring", labels = labs, title = "T1 (BGGM posterior mean)")
qgraph(pc_t2, layout = "spring", labels = labs, title = "T2 (BGGM posterior mean)")
qgraph(pc_t3, layout = "spring", labels = labs, title = "T3 (BGGM posterior mean)")

```



























